<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>CRM - Zetteri</title>
    <link rel="icon" type="image/x-icon" href="zetteri-favicon.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<body class="bg-gradient-to-br from-[#f6f8fa] to-[#e3eaf6] dark:from-[#14213d] dark:to-[#22272b]">
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
        <div id="main-header">
            <!-- El header se cargará aquí -->
        </div>

        <!-- Contenedor Principal del CRM -->
        <div class="flex flex-1 px-6 py-5 gap-6">
            <!-- Panel Izquierdo: Lista de Clientes -->
            <div id="client-list-panel" class="w-1/3 lg:w-1/4 bg-transparent flex flex-col space-y-4">
                <!-- Barra de Búsqueda -->
                <div class="px-1">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                            <div class="text-[#637588] flex border-none bg-[#f0f2f4] items-center justify-center pl-4 rounded-l-lg border-r-0" data-icon="MagnifyingGlass" data-size="24px" data-weight="regular">
                                <!-- Reemplazar con un SVG de lupa real -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                            </div>
                            <input
                                id="search-client-input"
                                placeholder="Search clients"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-lg text-[#111418] focus:outline-0 focus:ring-0 border-none bg-[#f0f2f4] focus:border-none h-full placeholder:text-[#637588] px-4 text-base font-normal leading-normal"
                                value=""
                            />
                        </div>
                    </label>
                </div>

                <!-- Título y Botón de Añadir Cliente -->
                <div class="flex justify-between items-center px-1 pt-2">
                    <h3 class="text-[#111418] text-lg font-bold leading-tight tracking-[-0.015em]">Client Management</h3>
                    <button id="add-new-client-btn" class="flex items-center justify-center rounded-lg h-8 px-3 bg-[#197fe5] text-white text-sm font-medium hover:bg-[#1365b7]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>
                        Add Client
                    </button>
                </div>

                <!-- Lista de Clientes (se llenará dinámicamente) -->
                <div id="client-list-container" class="overflow-y-auto flex-1 space-y-2 pr-2">
                    <!-- Ejemplo de item de cliente (se generará con JS) -->
                    <!--
                    <div class="client-item flex items-center gap-4 bg-white hover:bg-gray-50 cursor-pointer px-4 py-3 rounded-lg shadow">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-12 w-12" style='background-image: url("URL_FOTO_CLIENTE");'></div>
                        <div class="flex flex-col justify-center">
                            <p class="text-[#111418] text-base font-medium leading-normal line-clamp-1">Nombre Cliente</p>
                            <p class="text-[#637588] text-sm font-normal leading-normal line-clamp-2">Info breve (ej. email o última cita)</p>
                        </div>
                    </div>
                    -->
                </div>
            </div>

            <!-- Panel Derecho: Detalles del Cliente -->
            <div id="client-details-panel" class="w-2/3 lg:w-3/4 bg-transparent flex flex-col p-4 rounded-lg border border-gray-200 shadow-sm">
                <!-- Este panel se llenará cuando se seleccione un cliente -->
                <div id="client-details-content" class="flex-1">
                    <p class="text-gray-500 text-center py-10">Select a client to see their details.</p>
                    <!-- Aquí iría la estructura de Sophia Clark cuando un cliente esté seleccionado -->
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, where, 
            doc, getDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBppyJBT_uWC2hIJU-qnMZCNlac5uVTRmM", // Asegúrate que esta sea tu config correcta
            authDomain: "zetter-app.firebaseapp.com",
            projectId: "zetter-app",
            storageBucket: "zetter-app.appspot.com",
            messagingSenderId: "386722095231",
            appId: "1:386722095231:web:f5abe66895fea3746bdf4a",
            measurementId: "G-D7E0PDYDN5"
        };

        const app = initializeApp(firebaseConfig, "crmApp"); // Nombre único para la app de esta página
        const auth = getAuth(app);
        const db = getFirestore(app); // INICIALIZA FIRESTORE DB AQUÍ

        // --- Elementos del DOM para CRM ---
        const clientListContainer = document.getElementById('client-list-container');
        const clientDetailsContent = document.getElementById('client-details-content');
        const addNewClientBtn = document.getElementById('add-new-client-btn');
        const searchClientInput = document.getElementById('search-client-input');
        let currentUserId = null; 
        let unsubscribeClientsListener = null; // Para limpiar el listener de onSnapshot

        // --- Lógica Principal de Autenticación y Carga ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("CRM Page: User authenticated - UID:", currentUserId);
                loadClients(); 
                
                if (addNewClientBtn && !addNewClientBtn.hasAttribute('data-listener-attached')) {
                    addNewClientBtn.addEventListener('click', handleAddNewClientClick);
                    addNewClientBtn.setAttribute('data-listener-attached', 'true');
                }
                if (searchClientInput && !searchClientInput.hasAttribute('data-listener-attached')) {
                    searchClientInput.addEventListener('input', (e) => filterClients(e.target.value));
                    searchClientInput.setAttribute('data-listener-attached', 'true');
                }
            } else {
                currentUserId = null;
                console.log("CRM Page: User not authenticated. Redirecting to login.");
                if (unsubscribeClientsListener) {
                    unsubscribeClientsListener(); 
                    unsubscribeClientsListener = null;
                }
                if (clientListContainer) clientListContainer.innerHTML = '<p class="text-gray-500 p-4">Please log in to manage clients.</p>';
                if (clientDetailsContent) clientDetailsContent.innerHTML = '<p class="text-gray-500 text-center py-10">Please log in.</p>';
                window.location.href = 'index.html';
            }
        });

        // Cargar y mostrar header
        fetch('header.html')
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status} al cargar header.html`);
            return res.text();
          })
          .then(html => {
            const mainHeaderDiv = document.getElementById('main-header');
            if (mainHeaderDiv) {
                mainHeaderDiv.innerHTML = html;
                Array.from(mainHeaderDiv.querySelectorAll('script')).forEach(oldScript => {
                  const newScript = document.createElement('script');
                  Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                  if (oldScript.textContent) newScript.textContent = oldScript.textContent;
                  else if (oldScript.src) newScript.src = oldScript.src;
                  else { oldScript.remove(); return; }
                  document.body.appendChild(newScript); 
                  oldScript.remove();
                });
            } else { console.error("CRM page: Elemento con ID 'main-header' no encontrado."); }
          })
          .catch(err => console.error("CRM page: Error al cargar o procesar header.html:", err));
        
        // --- Funciones del CRM ---
        async function loadClients() {
            if (!currentUserId || !db) {
                console.error("CRM: loadClients - currentUserId o db no disponible.");
                return;
            }
            if (clientListContainer) clientListContainer.innerHTML = '<p class="text-gray-500 p-4">Loading clients...</p>';

            try {
                const clientsRef = collection(db, "users", currentUserId, "clients");
                const q = query(clientsRef, orderBy("name"));

                if (unsubscribeClientsListener) unsubscribeClientsListener(); 

                unsubscribeClientsListener = onSnapshot(q, (querySnapshot) => {
                    if (!clientListContainer) return;
                    if (querySnapshot.empty) {
                        clientListContainer.innerHTML = '<p class="text-gray-500 p-4">No clients found. Add your first client!</p>';
                        return;
                    }
                    clientListContainer.innerHTML = ''; 
                    querySnapshot.forEach((clientDoc) => {
                        renderClientInList(clientDoc.id, clientDoc.data());
                    });
                }, (error) => {
                    console.error("Error getting clients in real-time: ", error);
                    if (clientListContainer) clientListContainer.innerHTML = '<p class="text-red-500 p-4">Error loading clients.</p>';
                });

            } catch (error) {
                console.error("Error preparing to load clients: ", error);
                if (clientListContainer) clientListContainer.innerHTML = '<p class="text-red-500 p-4">Error loading clients.</p>';
            }
        }

        function renderClientInList(clientId, clientData) {
            if (!clientListContainer) return;
            const clientItem = document.createElement('div');
            clientItem.className = 'client-item flex items-center gap-4 bg-white hover:bg-gray-100 dark:bg-gray-800 dark:hover:bg-gray-700 cursor-pointer px-4 py-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600';
            clientItem.setAttribute('data-id', clientId);

            const photoUrl = clientData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(clientData.name || 'N A') + '&background=random';
            
            clientItem.innerHTML = `
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-10 w-10" style='background-image: url("${photoUrl}");'></div>
                <div class="flex flex-col justify-center overflow-hidden">
                    <p class="text-[#111418] dark:text-gray-200 text-sm font-medium leading-normal truncate">${clientData.name || 'N/A'}</p>
                    <p class="text-[#637588] dark:text-gray-400 text-xs font-normal leading-normal truncate">${clientData.email || clientData.phone || 'No contact info'}</p>
                </div>
            `;
            clientItem.addEventListener('click', () => loadClientDetails(clientId));
            clientListContainer.appendChild(clientItem);
        }
        
        function filterClients(searchTerm) {
            if (!clientListContainer) return;
            const term = searchTerm.toLowerCase().trim();
            const clientItems = clientListContainer.querySelectorAll('.client-item');
            clientItems.forEach(item => {
                const clientNameElement = item.querySelector('p:first-child');
                const clientContactElement = item.querySelector('p:last-child');
                const clientName = clientNameElement ? clientNameElement.textContent.toLowerCase() : '';
                const clientContact = clientContactElement ? clientContactElement.textContent.toLowerCase() : '';

                if (clientName.includes(term) || clientContact.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function loadClientDetails(clientId) {
            if (!currentUserId || !db || !clientDetailsContent) return;
            
            Array.from(clientListContainer.querySelectorAll('.client-item')).forEach(item => {
                item.classList.remove('bg-blue-100', 'dark:bg-blue-700', 'font-semibold');
                if (item.getAttribute('data-id') === clientId) {
                    item.classList.add('bg-blue-100', 'dark:bg-blue-700', 'font-semibold');
                }
            });

            clientDetailsContent.innerHTML = '<p class="text-gray-500 text-center py-10">Loading client details...</p>';
            try {
                const clientRef = doc(db, "users", currentUserId, "clients", clientId);
                const clientSnap = await getDoc(clientRef);

                if (clientSnap.exists()) {
                    renderClientDetails(clientId, clientSnap.data());
                } else {
                    clientDetailsContent.innerHTML = '<p class="text-red-500 text-center py-10">Client not found.</p>';
                }
            } catch (error) {
                console.error("Error loading client details: ", error);
                clientDetailsContent.innerHTML = '<p class="text-red-500 text-center py-10">Error loading client details.</p>';
            }
        }
        
        function renderClientDetails(clientId, clientData) {
            if (!clientDetailsContent) return;
            const clientSinceYear = clientData.createdAt && clientData.createdAt.seconds ? new Date(clientData.createdAt.seconds * 1000).getFullYear() : 'N/A';
            
            clientDetailsContent.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-3 pb-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex min-w-72 flex-col gap-1">
                        <p class="text-[#111418] dark:text-gray-100 tracking-light text-[32px] font-bold leading-tight">${clientData.name || 'N/A'}</p>
                        <p class="text-[#637588] dark:text-gray-400 text-sm font-normal leading-normal">Client since ${clientSinceYear}</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="edit-client-btn" class="px-3 py-1.5 text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">Edit</button>
                        <button id="delete-client-btn" class="px-3 py-1.5 text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">Delete</button>
                    </div>
                </div>
                <div class="py-3">
                    <div class="flex border-b border-[#dce0e5] dark:border-gray-700 gap-8">
                        <a class="tab-link active-tab flex cursor-pointer flex-col items-center justify-center border-b-[3px] border-b-[#111418] dark:border-b-blue-500 text-[#111418] dark:text-blue-500 pb-[13px] pt-4" data-tab="overview">
                            <p class="text-sm font-bold leading-normal tracking-[0.015em]">Overview</p>
                        </a>
                        <a class="tab-link flex cursor-pointer flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637588] dark:text-gray-400 pb-[13px] pt-4 hover:text-[#111418] dark:hover:text-gray-200" data-tab="appointments">
                            <p class="text-sm font-bold leading-normal tracking-[0.015em]">Appointments</p>
                        </a>
                        <a class="tab-link flex cursor-pointer flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637588] dark:text-gray-400 pb-[13px] pt-4 hover:text-[#111418] dark:hover:text-gray-200" data-tab="notes">
                            <p class="text-sm font-bold leading-normal tracking-[0.015em]">Notes</p>
                        </a>
                    </div>
                </div>

                <div id="tab-content-overview" class="tab-content block">
                    <h3 class="text-[#111418] dark:text-gray-200 text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Contact Information</h3>
                    <div class="p-4 grid grid-cols-[auto_1fr] gap-x-6 gap-y-3">
                        <p class="text-[#637588] dark:text-gray-400 text-sm font-normal">Email:</p><p class="text-[#111418] dark:text-gray-200 text-sm">${clientData.email || 'N/A'}</p>
                        <p class="text-[#637588] dark:text-gray-400 text-sm font-normal">Phone:</p><p class="text-[#111418] dark:text-gray-200 text-sm">${clientData.phone || 'N/A'}</p>
                        <p class="text-[#637588] dark:text-gray-400 text-sm font-normal">Address:</p><p class="text-[#111418] dark:text-gray-200 text-sm">${clientData.address || 'N/A'}</p>
                    </div>
                </div>
                <div id="tab-content-appointments" class="tab-content hidden">
                    <h3 class="text-[#111418] dark:text-gray-200 text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Appointment History</h3>
                    <div id="client-appointment-history-container" class="p-4"><p class="text-gray-500">Loading appointment history...</p></div>
                </div>
                <div id="tab-content-notes" class="tab-content hidden">
                    <h3 class="text-[#111418] dark:text-gray-200 text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Notes</h3>
                    <div class="p-4">
                        <textarea id="client-notes-textarea" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600" rows="5" placeholder="Add general notes for ${clientData.name}...">${clientData.generalNotes || ''}</textarea>
                        <button id="save-client-note-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Note</button>
                    </div>
                </div>
            `;
            setupTabs();
            loadClientAppointmentHistory(clientId); 
            
            document.getElementById('save-client-note-btn')?.addEventListener('click', () => saveClientGeneralNote(clientId));
            document.getElementById('edit-client-btn')?.addEventListener('click', () => handleEditClient(clientId, clientData));
            document.getElementById('delete-client-btn')?.addEventListener('click', () => handleDeleteClient(clientId));
        }
        
        async function loadClientAppointmentHistory(clientId) {
            const container = document.getElementById('client-appointment-history-container');
            if (!container || !currentUserId || !db) return;
            container.innerHTML = '<p class="text-gray-500 p-4">Loading appointment history...</p>';

            try {
                const appointmentsRef = collection(db, "users", currentUserId, "appointments");
                const q = query(appointmentsRef, where("clientId", "==", clientId), orderBy("date", "desc")); // Asume que tienes un campo 'clientId' en tus citas
                
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 p-4">No appointments found for this client.</p>';
                    return;
                }
                
                let html = '<ul class="space-y-3">';
                querySnapshot.forEach(docSnap => {
                    const appt = docSnap.data();
                    const apptDate = appt.date && appt.date.seconds ? new Date(appt.date.seconds * 1000).toLocaleDateString() : 'Date N/A';
                    const apptTime = appt.time || 'Time N/A';
                    const apptService = appt.service || 'Service N/A';
                    html += `<li class="p-3 border rounded dark:border-gray-600 bg-gray-50 dark:bg-gray-700"><strong>${apptService}</strong> on ${apptDate} at ${apptTime} <span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-600">${appt.status || 'Status N/A'}</span></li>`;
                });
                html += '</ul>';
                container.innerHTML = html;

            } catch (error) {
                console.error("Error loading client appointment history:", error);
                container.innerHTML = '<p class="text-red-500 p-4">Error loading appointment history.</p>';
            }
        }

        function setupTabs() {
            const tabLinks = clientDetailsContent.querySelectorAll('.tab-link');
            const tabContents = clientDetailsContent.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = link.getAttribute('data-tab');

                    tabLinks.forEach(l => {
                        l.classList.remove('active-tab', 'border-b-[#111418]', 'dark:border-b-blue-500', 'text-[#111418]', 'dark:text-blue-500');
                        l.classList.add('border-b-transparent', 'text-[#637588]', 'dark:text-gray-400');
                    });
                    link.classList.add('active-tab', 'border-b-[#111418]', 'dark:border-b-blue-500', 'text-[#111418]', 'dark:text-blue-500');
                    link.classList.remove('border-b-transparent', 'text-[#637588]', 'dark:text-gray-400');
                    
                    tabContents.forEach(content => {
                        if (content.id === `tab-content-${tabName}`) {
                            content.classList.remove('hidden');
                            content.classList.add('block');
                        } else {
                            content.classList.remove('block');
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        }

        function handleAddNewClientClick() {
            // TODO: Reemplazar prompts con un modal/formulario adecuado
            const clientName = prompt("Enter new client's name:");
            if (clientName && currentUserId) {
                const clientEmail = prompt("Enter client's email (optional):");
                const clientPhone = prompt("Enter client's phone (optional):");
                const clientAddress = prompt("Enter client's address (optional):");
                
                addClientToFirestore({ 
                    name: clientName.trim(), 
                    email: clientEmail ? clientEmail.trim() : '', 
                    phone: clientPhone ? clientPhone.trim() : '',
                    address: clientAddress ? clientAddress.trim() : '',
                    generalNotes: '',
                    createdAt: serverTimestamp()
                });
            }
        }
        
        async function addClientToFirestore(clientData) {
            if (!currentUserId || !db) {
                alert("Error: Not logged in or database not available.");
                return;
            }
            try {
                const clientsRef = collection(db, "users", currentUserId, "clients");
                const docRef = await addDoc(clientsRef, clientData);
                console.log("Client added with ID: ", docRef.id);
                // Opcional: Cargar detalles del nuevo cliente
                // loadClientDetails(docRef.id);
            } catch (e) {
                console.error("Error adding client: ", e);
                alert("Error adding client. See console for details.");
            }
        }

        async function saveClientGeneralNote(clientId) {
            const notesTextarea = document.getElementById('client-notes-textarea');
            if (notesTextarea && currentUserId && db && clientId) {
                const clientRef = doc(db, "users", currentUserId, "clients", clientId);
                try {
                    await updateDoc(clientRef, {
                        generalNotes: notesTextarea.value
                    });
                    alert("Client note saved!");
                } catch (error) {
                    console.error("Error saving client note:", error);
                    alert("Error saving client note.");
                }
            } else {
                alert("Error: Could not save note. Missing information.");
            }
        }

        function handleEditClient(clientId, clientData) {
            // TODO: Implementar un modal/formulario para editar, pre-llenado con clientData
            alert(`EDITING: ${clientData.name} (ID: ${clientId}). \nReplace this alert with a modal/form for editing.`);
            // Ejemplo de cómo podrías actualizar después de que el modal/formulario se envíe:
            // const newName = prompt("Enter new name:", clientData.name);
            // if (newName && currentUserId && db) {
            //   const clientRef = doc(db, "users", currentUserId, "clients", clientId);
            //   try {
            //     await updateDoc(clientRef, { name: newName.trim() });
            //     console.log("Client updated");
            //     // No es necesario llamar a loadClientDetails si onSnapshot está activo para la lista
            //     // y si los detalles se actualizan directamente o se recargan.
            //     // Para actualizar la vista de detalles inmediatamente:
            //     loadClientDetails(clientId); 
            //   } catch (e) { console.error("Error updating client", e); }
            // }
        }

        async function handleDeleteClient(clientId) {
            if (!currentUserId || !db) return;
            if (confirm("Are you sure you want to delete this client and all related data? This action cannot be undone.")) {
                try {
                    // TODO: Considerar eliminar datos relacionados (citas, etc.) o archivarlos.
                    const clientRef = doc(db, "users", currentUserId, "clients", clientId);
                    await deleteDoc(clientRef);
                    console.log("Client deleted:", clientId);
                    if (clientDetailsContent) clientDetailsContent.innerHTML = '<p class="text-gray-500 text-center py-10">Client deleted. Select another client from the list.</p>';
                } catch (error) {
                    console.error("Error deleting client:", error);
                    alert("Error deleting client.");
                }
            }
        }
    </script>
  </body>
</html>
