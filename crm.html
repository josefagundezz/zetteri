<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>CRM - Zetteri</title>
    <link rel="icon" type="image/x-icon" href="zetteri-favicon.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<body class="bg-gradient-to-br from-[#f6f8fa] to-[#e3eaf6] dark:from-[#14213d] dark:to-[#22272b]">
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
        <div id="main-header">
            <!-- El header se cargará aquí -->
        </div>

        <!-- Contenedor Principal del CRM -->
        <div class="flex flex-1 px-6 py-5 gap-6">
            <!-- Panel Izquierdo: Lista de Clientes -->
            <div id="client-list-panel" class="w-1/3 lg:w-1/4 bg-transparent flex flex-col space-y-4">
                <!-- Barra de Búsqueda -->
                <div class="px-1">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                            <div class="text-[#637588] flex border-none bg-[#f0f2f4] items-center justify-center pl-4 rounded-l-lg border-r-0" data-icon="MagnifyingGlass" data-size="24px" data-weight="regular">
                                <!-- Reemplazar con un SVG de lupa real -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                            </div>
                            <input
                                id="search-client-input"
                                placeholder="Search clients"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-lg text-[#111418] focus:outline-0 focus:ring-0 border-none bg-[#f0f2f4] focus:border-none h-full placeholder:text-[#637588] px-4 text-base font-normal leading-normal"
                                value=""
                            />
                        </div>
                    </label>
                </div>

                <!-- Título y Botón de Añadir Cliente -->
                <div class="flex justify-between items-center px-1 pt-2">
                    <h3 class="text-[#111418] text-lg font-bold leading-tight tracking-[-0.015em]">Client Management</h3>
                    <button id="add-new-client-btn" class="flex items-center justify-center rounded-lg h-8 px-3 bg-[#197fe5] text-white text-sm font-medium hover:bg-[#1365b7]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>
                        Add Client
                    </button>
                </div>

                <!-- Lista de Clientes (se llenará dinámicamente) -->
                <div id="client-list-container" class="overflow-y-auto flex-1 space-y-2 pr-2">
                    <!-- Ejemplo de item de cliente (se generará con JS) -->
                    <!--
                    <div class="client-item flex items-center gap-4 bg-white hover:bg-gray-50 cursor-pointer px-4 py-3 rounded-lg shadow">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-12 w-12" style='background-image: url("URL_FOTO_CLIENTE");'></div>
                        <div class="flex flex-col justify-center">
                            <p class="text-[#111418] text-base font-medium leading-normal line-clamp-1">Nombre Cliente</p>
                            <p class="text-[#637588] text-sm font-normal leading-normal line-clamp-2">Info breve (ej. email o última cita)</p>
                        </div>
                    </div>
                    -->
                </div>
            </div>

            <!-- Panel Derecho: Detalles del Cliente -->
            <div id="client-details-panel" class="w-2/3 lg:w-3/4 bg-transparent flex flex-col p-4 rounded-lg border border-gray-200 shadow-sm">
                <!-- Este panel se llenará cuando se seleccione un cliente -->
                <div id="client-details-content" class="flex-1">
                    <p class="text-gray-500 text-center py-10">Select a client to see their details.</p>
                    <!-- Aquí iría la estructura de Sophia Clark cuando un cliente esté seleccionado -->
                </div>
            </div>
        </div>
    </div>
    <div id="add-client-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
     <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <h2 class="text-xl font-bold mb-4 text-[#111418]">Add New Client</h2>
      <form id="add-client-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-[#111418] mb-1">Name<span class="text-red-500">*</span></label>
        <input type="text" id="client-name" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-[#111418] mb-1">Email</label>
        <input type="email" id="client-email" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-[#111418] mb-1">Phone</label>
        <input type="text" id="client-phone" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-[#111418] mb-1">Address</label>
        <input type="text" id="client-address" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="cancel-add-client" class="px-4 py-2 rounded bg-gray-200 text-[#111418] hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-[#197fe5] text-white hover:bg-[#1365b7]">Add</button>
       </div>
      </form>
     </div>
    </div>
    <div id="app-notification" class="fixed top-6 right-6 z-50 hidden min-w-[220px] max-w-xs px-4 py-3 rounded-lg shadow-lg bg-[#197fe5] text-white text-base font-medium transition-opacity duration-300"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBppyJBT_uWC2hIJU-qnMZCNlac5uVTRmM", // Reemplaza con tu config si es diferente
            authDomain: "zetter-app.firebaseapp.com",
            projectId: "zetter-app",
            storageBucket: "zetter-app.appspot.com",
            messagingSenderId: "386722095231",
            appId: "1:386722095231:web:f5abe66895fea3746bdf4a",
            measurementId: "G-D7E0PDYDN5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            }
        });

        fetch('header.html')
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.text();
          })
          .then(html => {
            const mainHeaderDiv = document.getElementById('main-header');
            if (mainHeaderDiv) {
                mainHeaderDiv.innerHTML = html;
                const scripts = Array.from(mainHeaderDiv.querySelectorAll('script'));
                scripts.forEach(oldScript => {
                  const newScript = document.createElement('script');
                  Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                  if (oldScript.textContent) newScript.textContent = oldScript.textContent;
                  else if (oldScript.src) newScript.src = oldScript.src;
                  else { oldScript.remove(); return; }
                  document.body.appendChild(newScript);
                  oldScript.remove();
                });
            } else {
                console.error("Appointments page: Elemento con ID 'main-header' no encontrado.");
            }
          })
          .catch(err => console.error("Appointments page: Error al cargar o procesar header.html:", err));

          // --- LÓGICA DEL CRM ---
        const clientListContainer = document.getElementById('client-list-container');
        const clientDetailsContent = document.getElementById('client-details-content');
        const addNewClientBtn = document.getElementById('add-new-client-btn');
        const searchClientInput = document.getElementById('search-client-input');
        let currentUserId = null; // Para almacenar el UID del usuario logueado

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                loadClients(); // Cargar clientes cuando el usuario esté autenticado
                // Aquí también puedes inicializar listeners para búsqueda, etc.
                if(searchClientInput) {
                    searchClientInput.addEventListener('input', (e) => {
                        filterClients(e.target.value);
                    });
                }
            } else {
                currentUserId = null;
                clientListContainer.innerHTML = '<p class="text-gray-500 p-4">Please log in to manage clients.</p>';
                clientDetailsContent.innerHTML = '<p class="text-gray-500 text-center py-10">Please log in.</p>';
            }
        });
        
        // Función para cargar clientes
        async function loadClients() {
            if (!currentUserId) return;
            clientListContainer.innerHTML = '<p class="text-gray-500 p-4">Loading clients...</p>'; // Indicador de carga

            try {
                const clientsRef = collection(db, "users", currentUserId, "clients");
                const q = query(clientsRef, orderBy("name")); // Ordenar por nombre, por ejemplo

                // Usar onSnapshot para actualizaciones en tiempo real
                onSnapshot(q, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        clientListContainer.innerHTML = '<p class="text-gray-500 p-4">No clients found. Add your first client!</p>';
                        return;
                    }
                    clientListContainer.innerHTML = ''; // Limpiar lista antes de repintar
                    querySnapshot.forEach((doc) => {
                        renderClientInList(doc.id, doc.data());
                    });
                }, (error) => {
                    console.error("Error getting clients in real-time: ", error);
                    clientListContainer.innerHTML = '<p class="text-red-500 p-4">Error loading clients.</p>';
                });

            } catch (error) {
                console.error("Error preparing to load clients: ", error);
                clientListContainer.innerHTML = '<p class="text-red-500 p-4">Error loading clients.</p>';
            }
        }

        // Función para renderizar un cliente en la lista
        function renderClientInList(clientId, clientData) {
            const clientItem = document.createElement('div');
            clientItem.className = 'client-item flex items-center gap-4 bg-white hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 cursor-pointer px-4 py-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600';
            clientItem.setAttribute('data-id', clientId);

            const photoUrl = clientData.photoURL || 'https://via.placeholder.com/150/cccccc/808080?Text=No+Image'; // Placeholder
            
            clientItem.innerHTML = `
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-12 w-12" style='background-image: url("${photoUrl}");'></div>
                <div class="flex flex-col justify-center overflow-hidden">
                    <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal truncate">${clientData.name || 'N/A'}</p>
                    <p class="text-[#637588] dark:text-gray-400 text-sm font-normal leading-normal truncate">${clientData.email || clientData.phone || 'No contact info'}</p>
                </div>
            `;
            clientItem.addEventListener('click', () => loadClientDetails(clientId));
            clientListContainer.appendChild(clientItem);
        }
        
        // Función para filtrar clientes (básica, se puede mejorar)
        function filterClients(searchTerm) {
            const term = searchTerm.toLowerCase();
            const clientItems = clientListContainer.querySelectorAll('.client-item');
            clientItems.forEach(item => {
                const clientName = item.querySelector('p:first-child').textContent.toLowerCase();
                if (clientName.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Función para cargar detalles de un cliente
        async function loadClientDetails(clientId) {
            if (!currentUserId) return;
            // Marcar cliente seleccionado en la lista (opcional)
            Array.from(clientListContainer.querySelectorAll('.client-item')).forEach(item => {
                item.classList.remove('bg-blue-100', 'dark:bg-blue-800', 'font-semibold');
                if (item.getAttribute('data-id') === clientId) {
                    item.classList.add('bg-blue-100', 'dark:bg-blue-800', 'font-semibold');
                }
            });

            clientDetailsContent.innerHTML = '<p class="text-gray-500 text-center py-10">Loading details...</p>';
            try {
                const clientRef = doc(db, "users", currentUserId, "clients", clientId);
                const clientSnap = await getDoc(clientRef);

                if (clientSnap.exists()) {
                    renderClientDetails(clientSnap.data());
                } else {
                    clientDetailsContent.innerHTML = '<p class="text-red-500 text-center py-10">Client not found.</p>';
                }
            } catch (error) {
                console.error("Error loading client details: ", error);
                clientDetailsContent.innerHTML = '<p class="text-red-500 text-center py-10">Error loading details.</p>';
            }
        }

        // Función para renderizar los detalles del cliente (similar a tu HTML estático)
        function renderClientDetails(clientData) {
            const clientSinceYear = clientData.createdAt ? new Date(clientData.createdAt.seconds * 1000).getFullYear() : 'N/A';
            // Aquí construirías el HTML para el panel derecho, similar a tu diseño estático.
            // Por simplicidad, solo mostraré algunos datos.
            clientDetailsContent.innerHTML = `
                <div class="flex flex-wrap justify-between gap-3 pb-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex min-w-72 flex-col gap-1">
                        <p class="text-[#111418] dark:text-gray-100 tracking-light text-[32px] font-bold leading-tight">${clientData.name || 'N/A'}</p>
                        <p class="text-[#637588] dark:text-gray-400 text-sm font-normal leading-normal">Client since ${clientSinceYear}</p>
                    </div>
                    <!-- Podrías añadir botones de Editar/Eliminar aquí -->
                </div>
                <div class="py-3">
                    <div class="flex border-b border-[#dce0e5] dark:border-gray-700 gap-8">
                        <a class="tab-link active-tab flex flex-col items-center justify-center border-b-[3px] border-b-[#111418] dark:border-b-blue-500 text-[#111418] dark:text-blue-500 pb-[13px] pt-4" href="#" data-tab="overview">
                            <p class="text-sm font-bold leading-normal tracking-[0.015em]">Overview</p>
                        </a>
                        <a class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637588] dark:text-gray-400 pb-[13px] pt-4 hover:text-[#111418] dark:hover:text-gray-200" href="#" data-tab="appointments">
                            <p class="text-sm font-bold leading-normal tracking-[0.015em]">Appointments</p>
                        </a>
                        <a class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#637588] dark:text-gray-400 pb-[13px] pt-4 hover:text-[#111418] dark:hover:text-gray-200" href="#" data-tab="notes">
                            <p class="text-sm font-bold leading-normal tracking-[0.015em]">Notes</p>
                        </a>
                    </div>
                </div>

                <div id="tab-content-overview" class="tab-content block">
                    <h3 class="text-[#111418] dark:text-gray-200 text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Contact information</h3>
                    <div class="p-4 grid grid-cols-[20%_1fr] gap-x-6">
                        <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#dce0e5] dark:border-gray-700 py-3">
                            <p class="text-[#637588] dark:text-gray-400 text-sm font-normal leading-normal">Email</p>
                            <p class="text-[#111418] dark:text-gray-200 text-sm font-normal leading-normal">${clientData.email || 'N/A'}</p>
                        </div>
                        <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#dce0e5] dark:border-gray-700 py-3">
                            <p class="text-[#637588] dark:text-gray-400 text-sm font-normal leading-normal">Phone</p>
                            <p class="text-[#111418] dark:text-gray-200 text-sm font-normal leading-normal">${clientData.phone || 'N/A'}</p>
                        </div>
                        <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#dce0e5] dark:border-gray-700 py-3">
                            <p class="text-[#637588] dark:text-gray-400 text-sm font-normal leading-normal">Address</p>
                            <p class="text-[#111418] dark:text-gray-200 text-sm font-normal leading-normal">${clientData.address || 'N/A'}</p>
                        </div>
                        <!-- Añadir más campos si los tienes: company, notes, etc. -->
                    </div>
                </div>
                <div id="tab-content-appointments" class="tab-content hidden">
                    <h3 class="text-[#111418] dark:text-gray-200 text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Appointment history</h3>
                    <!-- Aquí iría la tabla de historial de citas, que cargarías desde otra colección o subcolección -->
                    <p class="text-gray-500 p-4">Appointment history will be shown here.</p>
                </div>
                <div id="tab-content-notes" class="tab-content hidden">
                    <h3 class="text-[#111418] dark:text-gray-200 text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Notes</h3>
                    <!-- Aquí iría la sección de notas -->
                    <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600" rows="5" placeholder="Add notes for ${clientData.name}..."></textarea>
                    <button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Note</button>
                </div>
            `;
            setupTabs(); // Configurar listeners para las pestañas
        }
        
        function setupTabs() {
            const tabLinks = clientDetailsContent.querySelectorAll('.tab-link');
            const tabContents = clientDetailsContent.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = link.getAttribute('data-tab');

                    tabLinks.forEach(l => {
                        l.classList.remove('active-tab', 'border-b-[#111418]', 'dark:border-b-blue-500', 'text-[#111418]', 'dark:text-blue-500');
                        l.classList.add('border-b-transparent', 'text-[#637588]', 'dark:text-gray-400');
                    });
                    link.classList.add('active-tab', 'border-b-[#111418]', 'dark:border-b-blue-500', 'text-[#111418]', 'dark:text-blue-500');
                    link.classList.remove('border-b-transparent', 'text-[#637588]', 'dark:text-gray-400');
                    
                    tabContents.forEach(content => {
                        if (content.id === `tab-content-${tabName}`) {
                            content.classList.remove('hidden');
                            content.classList.add('block');
                        } else {
                            content.classList.remove('block');
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        }


        // Lógica para el botón "Add New Client" (abrir modal o formulario)
        
        async function addClientToFirestore(clientData) {
            if (!currentUserId) {
                return;
            }
            try {
                const clientsRef = collection(db, "users", currentUserId, "clients");
                const docRef = await addDoc(clientsRef, clientData);
                console.log("Client added with ID: ", docRef.id);
                // La lista se actualizará automáticamente gracias a onSnapshot
                // Opcionalmente, podrías cargar los detalles del nuevo cliente:
                // loadClientDetails(docRef.id); 
            } catch (e) {
                console.error("Error adding client: ", e);
            }
        }

        // Inicializar la carga de clientes si el usuario ya está logueado al cargar la página
        if (auth.currentUser) {
            currentUserId = auth.currentUser.uid;
            loadClients();
             if(searchClientInput) {
                searchClientInput.addEventListener('input', (e) => {
                    filterClients(e.target.value);
                });
            }
        }
        const addClientModal = document.getElementById('add-client-modal');
const addClientForm = document.getElementById('add-client-form');
const cancelAddClientBtn = document.getElementById('cancel-add-client');
const addNewClientBtnRef = document.getElementById('add-new-client-btn');

if (addNewClientBtnRef) {
    addNewClientBtnRef.addEventListener('click', () => {
        addClientModal.classList.remove('hidden');
    });
}
if (cancelAddClientBtn) {
    cancelAddClientBtn.addEventListener('click', () => {
        addClientModal.classList.add('hidden');
        addClientForm.reset();
    });
}

// Guardar cliente desde el modal
if (addClientForm) {
    addClientForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('client-name').value.trim();
        const email = document.getElementById('client-email').value.trim();
        const phone = document.getElementById('client-phone').value.trim();
        const address = document.getElementById('client-address').value.trim();

        if (!name) {
            showNotification("Name is required.", "error");
            return;
        }

        try {
            await addClientToFirestore({
                name,
                email,
                phone,
                address,
                createdAt: serverTimestamp()
            });
            showNotification("Client added!", "success");
            addClientModal.classList.add('hidden');
            addClientForm.reset();
        } catch (e) {
            showNotification("Error adding client.", "error");
            console.error(e);
        }
    });
}
function showNotification(message, type = "info", duration = 3000) {
    const notif = document.getElementById('app-notification');
    if (!notif) return;
    notif.textContent = message;
    notif.className = "fixed top-6 right-6 z-50 min-w-[220px] max-w-xs px-4 py-3 rounded-lg shadow-lg text-base font-medium transition-opacity duration-300";
    if (type === "success") notif.classList.add("bg-green-500");
    else if (type === "error") notif.classList.add("bg-red-500");
    else notif.classList.add("bg-[#197fe5]");
    notif.classList.remove("hidden");
    notif.style.opacity = "1";
    setTimeout(() => {
        notif.style.opacity = "0";
        setTimeout(() => notif.classList.add("hidden"), 300);
    }, duration);
}
    </script>
  </body>
</html>
